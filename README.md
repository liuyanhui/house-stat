# 房地产签约数据抓取程序

从北京市住建委网站自动抓取存量房网上签约数据，包括月度统计（经纪机构、区县、面积）和每日签约数据。

[![Python](https://img.shields.io/badge/Python-3.x-blue.svg)](https://www.python.org)
[![License](https://img.shields.io/badge/License-MIT-green.svg)](LICENSE)

## 功能特性

- ✅ 自动抓取上一个月的存量房签约数据
- ✅ 自动抓取最新日期的每日签约数据
- ✅ 五类数据统计：经纪机构、区县、面积、每日、月度汇总
- ✅ 智能去重：避免重复抓取相同月份数据
- ✅ 完整日志：记录所有操作和数据状态
- ✅ 数据转置：自动将横向表格转换为竖向格式
- ✅ 异常处理：网络失败自动重试

## 数据来源

- **数据源**：北京市住房和城乡建设委员会
- **URL**：http://bjjs.zjw.beijing.gov.cn/eportal/ui?pageId=307749
- **数据类型**：存量房（二手房）网上签约统计
- **更新频率**：每日更新

## 安装依赖

```bash
pip install requests beautifulsoup4 pandas python-dateutil
```

或使用 requirements.txt：

```bash
pip install -r requirements.txt
```

## 使用方法

### 1. 基本使用

直接运行程序：

```bash
python house_stat.py
```

程序会自动：
1. 抓取最新网页数据
2. 提取数据年月
3. 解析四类数据（经纪机构、区县、面积、每日）
4. 保存到CSV文件（如已存在则跳过）
5. 输出统计信息

### 2. 首次运行

首次运行会创建以下文件：
- `month_agency.csv` - 经纪机构月度数据
- `month_district.csv` - 区县月度数据
- `month_area.csv` - 面积月度数据
- `daily.csv` - 每日存量房网上签约数据
- `month.csv` - 月度汇总数据（网上签约套数、网上签约面积、住宅签约套数、住宅签约面积）
- `house_stat.log` - 运行日志

### 3. 后续运行

程序会自动检查数据是否已存在：
- 如果数据已存在：记录日志并跳过
- 如果数据不存在：追加新数据

建议每日或定期运行程序以获取最新数据。

## 输出文件格式

### month_agency.csv
```csv
年月,序号,经纪机构,签约套数,退房套数
2025-12,1,北京链家置地房地产经纪有限公司,8695,150
2025-12,2,北京我爱我家房地产经纪有限公司,1926,58
```

### month_district.csv
```csv
年月,区县,签约套数,成交面积
2025-12,全市,19132,1659092.40
2025-12,东城,755,53740.86
2025-12,朝阳,4520,407002.24
```

### month_area.csv
```csv
年月,面积区间,成交套数,成交面积
2025-12,60m²以下,5824,264050.14
2025-12,60～80m²,4543,314581.97
2025-12,80～100m²,4154,370361.38
```

### daily.csv
```csv
日期,签约套数,签约面积,住宅签约套数,住宅签约面积
2026-01-05,539,46824.56,484,43670.70
2026-01-06,123,10500.00,100,9500.00
```

### month.csv
```csv
月份,网上签约套数,网上签约面积(m2),住宅签约套数,住宅签约面积(m2)
2025-12,19132,1659092.40,17200,1549550.80
2025-11,18234,1580000.50,16300,1430000.20
```

## 配置说明

编辑 `config.py` 可以修改以下配置：

```python
# 数据源 URL
BASE_URL = "http://bjjs.zjw.beijing.gov.cn/eportal/ui?pageId=307749"

# CSV 文件路径
AGENCY_CSV = "month_agency.csv"
DISTRICT_CSV = "month_district.csv"
AREA_CSV = "month_area.csv"
DAILY_CSV = "daily.csv"
MONTH_CSV = "month.csv"

# 日志文件路径
LOG_FILE = "house_stat.log"

# 重试次数和延迟
MAX_RETRIES = 3
RETRY_DELAY = 5  # 秒
```

## 日志示例

```
[2026-01-06 10:00:00] INFO ==================================================
[2026-01-06 10:00:00] INFO 开始抓取存量房签约数据
[2026-01-06 10:00:00] INFO ==================================================
[2026-01-06 10:00:01] INFO 正在抓取数据（第 1 次尝试）...
[2026-01-06 10:00:02] INFO 成功获取网页内容
[2026-01-06 10:00:02] INFO 提取到数据年月：2025-12
[2026-01-06 10:00:02] INFO --------------------------------------------------
[2026-01-06 10:00:02] INFO 开始解析经纪机构数据...
[2026-01-06 10:00:03] INFO 成功解析经纪机构数据 10 条
[2026-01-06 10:00:03] INFO 开始解析区县数据...
[2026-01-06 10:00:03] INFO 成功解析区县数据 18 条
[2026-01-06 10:00:04] INFO 开始解析面积数据...
[2026-01-06 10:00:04] INFO 成功解析面积数据 6 条
[2026-01-06 10:00:04] INFO 开始解析每日数据...
[2026-01-06 10:00:05] INFO 解析每日数据，日期：2026-01-05
[2026-01-06 10:00:05] INFO 成功解析每日数据 1 条
[2026-01-06 10:00:05] INFO --------------------------------------------------
[2026-01-06 10:00:05] INFO 开始保存数据到CSV文件...
[2026-01-06 10:00:06] INFO 创建新文件 month_agency.csv，写入 10 条数据
[2026-01-06 10:00:06] INFO 新增 10 条数据到 month_agency.csv
[2026-01-06 10:00:06] INFO 创建新文件 month_district.csv，写入 18 条数据
[2026-01-06 10:00:06] INFO 新增 18 条数据到 month_district.csv
[2026-01-06 10:00:07] INFO 创建新文件 month_area.csv，写入 6 条数据
[2026-01-06 10:00:07] INFO 新增 6 条数据到 month_area.csv
[2026-01-06 10:00:07] INFO 创建新文件 daily.csv，写入 1 条数据
[2026-01-06 10:00:07] INFO 新增 1 条数据到 daily.csv
[2026-01-06 10:00:08] INFO 创建新文件 month.csv，写入 1 条数据
[2026-01-06 10:00:08] INFO 新增 1 条数据到 month.csv
[2026-01-06 10:00:08] INFO --------------------------------------------------
[2026-01-06 10:00:08] INFO 数据抓取统计：
[2026-01-06 10:00:08] INFO   目标年月：2025-12
[2026-01-06 10:00:08] INFO   经纪机构：抓取 10 条，新增 10 条，已存在 0 条
[2026-01-06 10:00:08] INFO   区县数据：抓取 18 条，新增 18 条，已存在 0 条
[2026-01-06 10:00:08] INFO   面积数据：抓取 6 条，新增 6 条，已存在 0 条
[2026-01-06 10:00:08] INFO   每日数据：抓取 1 条，新增 1 条，已存在 0 条
[2026-01-06 10:00:08] INFO   月度汇总：抓取 1 条，新增 1 条，已存在 0 条
[2026-01-06 10:00:08] INFO ==================================================
[2026-01-06 10:00:08] INFO 数据抓取完成！
[2026-01-06 10:00:08] INFO ==================================================
```

## 注意事项

1. **数据时效性**：
   - 月度数据：页面显示的是上一个月的完整数据
   - 每日数据：页面显示的是最新日期的签约数据

2. **网络要求**：需要能够访问北京市住建委网站

3. **文件编码**：CSV文件使用UTF-8 with BOM编码，Excel可直接打开

4. **数据去重**：程序会自动检查并跳过已存在的数据
   - 月度数据：基于年月+唯一字段（机构/区县/面积区间）
   - 每日数据：基于日期
   - 月度汇总：基于月份

5. **日志记录**：所有操作都会记录到日志文件，方便排查问题

## 常见问题

### Q1: 程序报错"未找到表格"怎么办？
A: 可能是网站结构发生变化，请查看实际网页结构并修改代码中的表格ID或查找逻辑。

### Q2: 如何查看历史月份数据？
A: 程序每次运行都会追加新数据到CSV文件，可以直接在CSV中查看所有历史记录。

### Q3: 每日数据会重复抓取吗？
A: 不会。程序会检查日期，如果同日期的数据已存在，会自动跳过。

### Q4: 可以设置定时自动运行吗？
A: 可以使用Windows任务计划程序或Linux的cron来设置定时任务。

## 技术栈

- Python 3.x
- requests - HTTP请求
- BeautifulSoup4 - HTML解析
- pandas - 数据处理
- logging - 日志记录

## 文件结构

```
house-stat/
├── house_stat.py          # 主程序
├── config.py              # 配置文件
├── README.md              # 使用说明（本文件）
├── PLAN.md                # 实现计划文档
├── requirements.txt       # Python依赖（需创建）
├── month_agency.csv       # 经纪机构数据（运行后生成）
├── month_district.csv     # 区县数据（运行后生成）
├── month_area.csv         # 面积数据（运行后生成）
├── daily.csv              # 每日数据（运行后生成）
├── month.csv              # 月度汇总数据（运行后生成）
└── house_stat.log         # 运行日志（运行后生成）
```

## 许可证

本项目仅供学习和研究使用，请遵守目标网站的使用条款。

## 更新日志

### v1.0.0 (2026-01-06)
- 初始版本发布
- 支持抓取三类月度数据：经纪机构、区县、面积
- 支持抓取每日签约数据
- 实现数据去重和日志记录
- 支持自动重试和异常处理
