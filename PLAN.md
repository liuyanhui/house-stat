# 房地产签约数据抓取程序 - 实现计划

## 项目概述
从北京市住建委网站抓取**存量房网上签约月统计数据**，按经纪机构、区县、面积三个维度统计，并按月存储到 CSV 文件中。

## 数据来源
- **URL**: `http://bjjs.zjw.beijing.gov.cn/eportal/ui?pageId=307749`
- **数据类型**: 存量房（二手房）网上签约月统计
- **数据时间**: 页面显示上一个月的完整月度数据
- **无需参数**: 页面自动显示最新月度数据

## 网页结构分析

### 1. 页面包含三个数据表格（全部在同一HTML中）

#### 表格1: 按经纪机构统计 (`id="table_clf1"`)
```
列名：序号、房地产经纪机构名称、签约套数、退房套数
示例数据：
1 | 北京链家置地房地产经纪有限公司 | 8695 | 150
2 | 北京我爱我家房地产经纪有限公司 | 1926 | 58
```

#### 表格2: 按所在区县统计 (`id="table_clf2"`)
```
横向表头：所在区（全市、东城、西城、朝阳、海淀、丰台、石景山、通州、房山、顺义、门头沟、大兴、怀柔、密云、昌平、延庆、平谷、开发区）
行：套数、成交面积(m²)
需要转换为竖向格式
```

#### 表格3: 按建筑面积统计 (`id="table_clf3"`)
```
横向表头：面积（60m²以下、60～80m²、80～100m²、100～120m²、120～140m²、140m²以上）
行：成交套数、成交面积(m²)
需要转换为竖向格式
```

### 2. 数据时间识别
页面标题包含年月信息，如：`2025年12月存量房网上签约`

## 技术栈
- **Python 3.x**
- **requests** - 发送 HTTP 请求
- **BeautifulSoup4** - 解析 HTML 表格
- **pandas** - 处理 CSV 数据
- **logging** - 记录日志

## 目录结构
```
house-stat/
├── house_stat.py          # 主程序
├── config.py              # 配置文件
├── month_agency.csv       # 经纪机构月度数据
├── month_district.csv     # 区县月度数据
├── month_area.csv         # 面积月度数据
├── house_stat.log         # 运行日志
├── PLAN.md                # 本计划文档
└── README.md              # 使用说明
```

## 实现步骤

### 1. 配置模块 (config.py)
```python
# 配置项
BASE_URL = "http://bjjs.zjw.beijing.gov.cn/eportal/ui?pageId=307749"
AGENCY_CSV = "month_agency.csv"
DISTRICT_CSV = "month_district.csv"
AREA_CSV = "month_area.csv"
LOG_FILE = "house_stat.log"
```

### 2. 数据抓取模块

#### 函数1: `fetch_data()`
- 发送 HTTP 请求获取网页
- 使用 User-Agent 伪装浏览器
- 失败重试 3 次
- 返回 BeautifulSoup 对象

#### 函数2: `extract_data_month(soup)`
- 从页面标题提取年月
- 格式：`2025年12月` → `2025-12`
- 返回 (year, month) 元组

#### 函数3: `parse_agency_data(soup, year_month)`
- 查找 `id="table_clf1"` 的表格
- 解析每一行经纪机构数据
- 提取：序号、机构名称、签约套数、退房套数
- 返回 DataFrame，添加 `年月` 列

#### 函数4: `parse_district_data(soup, year_month)`
- 查找 `id="table_clf2"` 的表格
- 解析横向表头（区县名）和数据行（套数、面积）
- **转置数据**：将横向转换为竖向
- 每个区县一行：年月、区县、签约套数、成交面积
- 返回 DataFrame

#### 函数5: `parse_area_data(soup, year_month)`
- 查找 `id="table_clf3"` 的表格
- 解析横向表头（面积区间）和数据行（套数、面积）
- **转置数据**：将横向转换为竖向
- 每个面积区间一行：年月、面积区间、成交套数、成交面积
- 返回 DataFrame

### 3. 数据存储模块

#### 函数: `save_to_csv(df, csv_file, key_columns)`
- 检查 CSV 文件是否存在
- 如果存在：
  - 读取现有数据
  - 检查是否已存在相同 `年月` 的数据
  - 如果已存在：记录日志，跳过
  - 如果不存在：追加新数据
- 如果不存在：创建新文件并写入数据
- 返回：(新增条数, 跳过条数)

### 4. 主程序流程 (house_stat.py)

```python
1. 初始化日志系统
2. 抓取网页 HTML
3. 提取数据年月（从页面标题）
4. 解析三类数据：
   - 经纪机构数据
   - 区县数据（转置）
   - 面积数据（转置）
5. 保存到 CSV：
   - 检查是否已存在
   - 追加或跳过
6. 输出统计信息：
   - 目标年月
   - 各类数据抓取条数
   - 各类数据新增条数
   - 各类数据已存在条数
7. 记录完成日志
```

## CSV 数据格式

### month_agency.csv
```csv
年月,序号,经纪机构,签约套数,退房套数
2025-12,1,北京链家置地房地产经纪有限公司,8695,150
2025-12,2,北京我爱我家房地产经纪有限公司,1926,58
```

### month_district.csv
```csv
年月,区县,签约套数,成交面积
2025-12,全市,19132,1659092.40
2025-12,东城,755,53740.86
2025-12,朝阳,4520,407002.24
```

### month_area.csv
```csv
年月,面积区间,成交套数,成交面积
2025-12,60m²以下,5824,264050.14
2025-12,60～80m²,4543,314581.97
2025-12,80～100m²,4154,370361.38
```

## 关键功能点

### 1. 日期提取
- 使用正则表达式从页面标题提取年月
- 模式：`(\d{4})年(\d{1,2})月存量房网上签约`
- 格式化为：`YYYY-MM`

### 2. 表格转置（区县和面积数据）
由于 HTML 表格是横向布局，需要转置：
```python
# 伪代码
headers = [全市, 东城, 西城, ...]  # 第一行
counts = [19132, 755, 1029, ...]   # 第二行
areas = [1659092, 53740, ...]      # 第三行

# 转换为竖向
for i, district in enumerate(headers):
    row = {
        '年月': year_month,
        '区县': district,
        '签约套数': counts[i],
        '成交面积': areas[i]
    }
```

### 3. 数据去重
- 唯一标识：`年月` + 具体维度字段
  - 经纪机构：`年月` + `经纪机构`
  - 区县：`年月` + `区县`
  - 面积：`年月` + `面积区间`
- 使用 pandas merge 或 drop_duplicates 检测重复

### 4. 异常处理
- 网络请求失败：重试 3 次，每次间隔 5 秒
- HTML 解析失败：记录详细错误信息和原始 HTML 片段
- 数据格式不匹配：记录警告并跳过该行

### 5. 日志记录示例
```
[2026-01-06 10:00:00] INFO ===== 开始抓取存量房签约数据 =====
[2026-01-06 10:00:01] INFO 成功获取网页，数据年月：2025-12
[2026-01-06 10:00:02] INFO 成功解析经纪机构数据 10 条
[2026-01-06 10:00:03] INFO 成功解析区县数据 18 条
[2026-01-06 10:00:04] INFO 成功解析面积数据 6 条
[2026-01-06 10:00:05] INFO 保存经纪机构数据：新增 10 条，已存在 0 条
[2026-01-06 10:00:06] INFO 保存区县数据：新增 18 条，已存在 0 条
[2026-01-06 10:00:07] INFO 保存面积数据：新增 6 条，已存在 0 条
[2026-01-06 10:00:07] INFO ===== 数据抓取完成 =====
```

## 使用方式

### 安装依赖
```bash
pip install requests beautifulsoup4 pandas python-dateutil
```

### 运行程序
```bash
python house_stat.py
```

### 首次运行
- 创建 3 个 CSV 文件
- 写入当前页面的月度数据

### 后续运行
- 自动检测数据是否已存在
- 只追加新数据
- 记录详细日志

## 注意事项

### 1. 数据时效性
- 页面显示的是**上一个月**的完整数据
- 每月月初运行一次即可
- 例如：1月6日运行，获取的是2025年12月的数据

### 2. 反爬措施
- 添加 User-Agent 伪装浏览器
- 请求间隔：单次请求，无需延迟
- 如遇限制，可添加随机延迟

### 3. 数据完整性
- 页面可能随时改版，需要定期检查 HTML 结构
- 建议添加数据验证：确保解析的数据行数合理
- 如果解析失败，发送邮件或推送通知

### 4. 字符编码
- 网页使用 UTF-8 编码
- CSV 文件使用 UTF-8 with BOM 编码（Excel 友好）

## 后续优化（可选）

1. **命令行参数支持**
   ```bash
   python house_stat.py --year 2025 --month 12
   ```

2. **数据验证和清洗**
   - 检查数据类型正确性
   - 处理缺失值和异常值
   - 验证套数和面积的合理性

3. **多个月份批量抓取**
   - 如果网站提供历史数据查询接口
   - 批量获取历史月度数据

4. **数据可视化**
   - 生成月度趋势图表
   - 区县对比分析

5. **自动化部署**
   - 设置 Windows 定时任务
   - 每月 5 日自动运行
   - 失败时发送告警

---
请确认此计划是否符合需求，或提出修改建议。
确认后我将开始编写程序代码。
